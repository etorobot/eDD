//Code originally written by; Ahmed A. Radwan (author),  Maisa Jazba 
//edited by etorobot

#include <ArduinoHardware.h>
#include <ros.h>
#include <geometry_msgs/Twist.h>

#define EN_A 13
#define IN1 12
#define IN2 11
#define EN_B 8
#define IN4 9
#define IN3 10
//#deifne headlite
//#define tailite 

double w_r=0, w_l=0, wheel_rad = 0.08, wheel_sep = 0.20, lite;

ros::NodeHandle nh;
int lowSpeed = 255, highSpeed = 0;
double speed_ang=0, speed_lin=0;

void messageCb( const geometry_msgs::Twist& msg){
  speed_ang = msg.angular.z;
  speed_lin = msg.linear.x;
  w_r = (speed_lin/wheel_rad) + ((speed_ang*wheel_sep)/(2.0*wheel_rad));
  w_l = (speed_lin/wheel_rad) - ((speed_ang*wheel_sep)/(2.0*wheel_rad));	}

ros::Subscriber<geometry_msgs::Twist> sub("cmd_vel", &messageCb );
void Motors_init();
void MotorL(int PWML);
void MotorR(int PWMR);

void setup(){
 Motors_init();
 nh.initNode();
 nh.subscribe(sub);	}

void loop(){
 MotorL(w_l*10);
 MotorR(w_r*10);
//ws28();
 nh.spinOnce();	}

void Motors_init(){
 pinMode(EN_A, OUTPUT);
 pinMode(EN_B, OUTPUT);
 pinMode(IN1, OUTPUT);
 pinMode(IN2, OUTPUT);
 pinMode(IN4, OUTPUT);
 pinMode(IN3, OUTPUT);
 digitalWrite(EN_A, LOW);
 digitalWrite(EN_B, LOW);
 digitalWrite(IN1, LOW);
 digitalWrite(IN2, LOW);
 digitalWrite(IN4, LOW);
 digitalWrite(IN3, LOW);	}

void MotorL(int PWML){
 if (PWML > 0){
     analogWrite(EN_A, PWML);
     digitalWrite(IN1, HIGH);
     digitalWrite(IN2, LOW);	}

 if (PWML < 0){
     PWML=abs(PWML);
     analogWrite(EN_A, PWML);
     digitalWrite(IN1, LOW);
     digitalWrite(IN2, HIGH);	}

 if (PWML == 0){
     analogWrite(EN_A, PWML);
     digitalWrite(IN1, LOW);
     digitalWrite(IN2, LOW);	}
}

void MotorR(int PWMR){

 if (PWMR > 0){
     analogWrite(EN_B, PWMR);
     digitalWrite(IN4, HIGH);
     digitalWrite(IN3, LOW);	 }

 if (PWMR < 0){
     PWMR=abs(PWMR);
     analogWrite(EN_B, PWMR);
     digitalWrite(IN4, LOW);
     digitalWrite(IN3, HIGH);	 }

 if (PWMR == 0){
     analogWrite(EN_B, PWMR);
     digitalWrite(IN4, LOW);
     digitalWrite(IN3, LOW);	}
}
/*
void ws28(){
if (PWMR>0){
digitalWrite(
if 